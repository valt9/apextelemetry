{% extends "base.html" %}

{% block title %}New Session - Apex Telemetry{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0"><i class="bi bi-plus-circle"></i> Create New Session</h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> <strong>Modern Era Data:</strong> Data is pulled from F1 races from 2000 to present. All current and modern era drivers are available.
                </div>
                <form method="POST" action="{{ url_for('new_session') }}">
                    <div class="mb-3">
                        <label for="session_name" class="form-label">Session Name</label>
                        <input type="text" class="form-control" id="session_name" name="session_name" 
                               placeholder="e.g., Monaco GP 2024" required>
                    </div>
                    <div class="mb-3">
                        <label for="driver_name" class="form-label">Driver Name</label>
                        <select class="form-select" id="driver_name" name="driver_name" required>
                            <option value="">Select a driver...</option>
                            {% for driver in drivers %}
                            <option value="{{ driver.name }}">{{ driver.name }}{% if driver.code %} ({{ driver.code }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Select from modern era F1 drivers (2000-present)</small>
                    </div>
                    <div class="mb-3">
                        <label for="race_search" class="form-label">Search Race</label>
                        <input type="text" class="form-control" id="race_search" placeholder="Type to search races...">
                        <small class="form-text text-muted">Start typing to filter races</small>
                    </div>
                    <div class="mb-3">
                        <label for="race_selection" class="form-label">Race</label>
                        <select class="form-select" id="race_selection" name="race_selection" required disabled>
                            <option value="">Select a driver first...</option>
                        </select>
                        <small class="form-text text-muted">Races are filtered to show only races this driver participated in</small>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Create Session</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const driverSelect = document.getElementById('driver_name');
const raceSearch = document.getElementById('race_search');
const raceSelect = document.getElementById('race_selection');
let allRaces = [];

driverSelect.addEventListener('change', async function() {
    const driverName = this.value;
    raceSelect.disabled = true;
    raceSelect.innerHTML = '<option value="">Loading races...</option>';
    raceSearch.value = '';
    
    if (!driverName) {
        raceSelect.innerHTML = '<option value="">Select a driver first...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/driver-races/${encodeURIComponent(driverName)}`);
        const races = await response.json();
        allRaces = races;
        
        if (races.length === 0) {
            raceSelect.innerHTML = '<option value="">No races found for this driver</option>';
        } else {
            updateRaceOptions(races);
            raceSelect.disabled = false;
        }
    } catch (error) {
        console.error('Error fetching races:', error);
        raceSelect.innerHTML = '<option value="">Error loading races</option>';
    }
});

raceSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const filtered = allRaces.filter(race => 
        race.display_name.toLowerCase().includes(searchTerm) ||
        race.name.toLowerCase().includes(searchTerm) ||
        race.circuit.toLowerCase().includes(searchTerm) ||
        race.location.toLowerCase().includes(searchTerm) ||
        race.country.toLowerCase().includes(searchTerm)
    );
    updateRaceOptions(filtered);
});

function updateRaceOptions(races) {
    raceSelect.innerHTML = '';
    if (races.length === 0) {
        raceSelect.innerHTML = '<option value="">No races match your search</option>';
        return;
    }
    
    races.forEach(race => {
        const option = document.createElement('option');
        option.value = `${race.year}|${race.round}|${race.date}`;
        option.textContent = race.display_name;
        raceSelect.appendChild(option);
    });
}
</script>
{% endblock %}

